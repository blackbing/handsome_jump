// Generated by CoffeeScript 1.3.3
(function() {

  define(function(require) {
    var CircleView, circleView_tpl, wifi;
    wifi = require('./lib/wifiscan');
    circleView_tpl = require('hbs!./circle');
    return CircleView = Backbone.View.extend({
      className: 'handsome-jump center',
      events: {
        'click #refresh': 'refreshIP'
      },
      refreshIP: function() {
        var callbacks, scanCallbacks,
          _this = this;
        callbacks = $.Callbacks();
        callbacks.add(function() {
          console.log('callbacks');
          return _this.ipfound.apply(_this, arguments);
        });
        return scanCallbacks = wifi.scan(callbacks);
      },
      ipfound: function(data) {
        var $avator, avatorPos, avatorUrl, ip;
        console.log('ipfound', data);
        ip = data.ip;
        avatorUrl = data.url;
        if (ip === wifi.mySelfIP) {
          return $('.myself').hide().addClass('avator img-circle').css({
            backgroundImage: "url(" + avatorUrl + ")"
          }).fadeIn();
        } else {
          /*
                  $avators = $('.connected li').not('.avator')
                  random_idx = Math.floor(Math.random()*$avators.length)
                  $avators.eq(random_idx)
                    .hide()
                    .addClass('avator img-circle')
                    .css(
                      backgroundImage: "url(#{avatorUrl})"
                    )
                    .fadeIn()
          */

          avatorPos = this.getBlankAvatorPos();
          $avator = $('<div />', {
            "class": 'avator img-circle'
          }).css({
            backgroundImage: "url(" + avatorUrl + ")",
            left: avatorPos.left,
            top: avatorPos.top
          });
          return this.$('.connected').append($avator);
        }
      },
      getBlankAvatorPos: (function() {
        var avator, getRandom, radius_delta, radius_min;
        avator = {
          width: 100,
          height: 100
        };
        radius_min = 200;
        radius_delta = 150;
        getRandom = function(canvas) {
          var r, radius_max, theta;
          radius_max = Math.min(canvas.width / 2, canvas.height / 2, radius_min + radius_delta);
          r = (Math.random() * (radius_max - radius_min)) + radius_min;
          theta = Math.random() * 360;
          return [r, theta];
        };
        return function() {
          var canvas, pos, r, ran, theta, x, y;
          canvas = {
            width: this.$('.connected').width(),
            height: this.$('.connected').height()
          };
          console.log(canvas);
          ran = getRandom(canvas);
          r = ran[0];
          theta = ran[1];
          x = (r * Math.cos(theta)) + canvas.width / 2;
          y = r * Math.sin(theta) + canvas.height / 2;
          return pos = {
            left: x - (avator.width / 2),
            top: y - (avator.height / 2)
          };
        };
      })(),
      drawCircle: function() {
        var $c, $circle, $handsomeJump, $inner, innerWidth;
        $circle = this.$(".circle");
        $inner = $circle;
        $handsomeJump = this.$(".handsome-jump");
        innerWidth = $circle.width();
        $circle.css({
          height: innerWidth,
          width: innerWidth
        });
        while ($inner.width() > 300) {
          $c = $("<div class=\"circle-inner center\" />");
          $inner.append($c);
          $inner = $c;
        }
        return this.$('.circle-inner').last().append('<div class="myself center" />');
      },
      initialize: function() {
        return console.log('initialize');
      },
      render: function() {
        var tpl;
        console.log('render');
        tpl = circleView_tpl();
        this.$el.append(tpl);
        this.drawCircle();
        return this.refreshIP();
      },
      remove: function() {
        return console.log('remove');
      }
    });
  });

}).call(this);
